{% extends "templatesApp1Discopro/_base_layout.html" %}
{% load static %}

{% block title %}Listado de Motoristas{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold text-secondary">
        <i class="fas fa-motorcycle me-2"></i> Motoristas
    </h2>

    <a href="{% url 'motorista_crear' %}" class="btn btn-primary">
        <i class="fas fa-plus-circle me-1"></i> Nuevo Motorista
    </a>
</div>

<!-- Buscador -->
<form method="GET" class="mb-3">
    <div class="input-group">
        <input type="text" name="q" class="form-control"
               placeholder="Buscar motorista..." value="{{ request.GET.q }}">
        <button class="btn btn-primary" type="submit">
            <i class="fas fa-search"></i>
        </button>
    </div>
</form>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">

            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th><a href="?sort=nombre" class="text-white">Nombre</a></th>
                        <th><a href="?sort=rut" class="text-white">RUT</a></th>
                        <th><a href="?sort=telefono" class="text-white">Teléfono</a></th>
                        <th><a href="?sort=region" class="text-white">Región</a></th>
                        <th><a href="?sort=provincia" class="text-white">Provincia</a></th>
                        <th><a href="?sort=comuna" class="text-white">Comuna</a></th>
                        <th>Farmacia Actual</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>

                <tbody>

                    {% for motorista in motoristas %}
                    <tr>

                        <td>{{ motorista.nombres }} {{ motorista.apellido_paterno }}</td>
                        <td>{{ motorista.rut }}</td>
                        <td>{{ motorista.telefono|default:"-" }}</td>

                        <!-- REGIÓN -->
                        <td>
                            {% if motorista.comuna %}
                                {{ motorista.comuna.provincia.region.nombreRegion }}
                            {% else %}-{% endif %}
                        </td>

                        <!-- PROVINCIA -->
                        <td>
                            {% if motorista.comuna %}
                                {{ motorista.comuna.provincia.nombreProvincia }}
                            {% else %}-{% endif %}
                        </td>

                        <!-- COMUNA -->
                        <td>
                            {% if motorista.comuna %}
                                {{ motorista.comuna.nombreComuna }}
                            {% else %}-{% endif %}
                        </td>

                        <!-- FARMACIA ACTUAL -->
                        <td>
                            {% with ultima=motorista.asignacionfarmacia_set.last %}
                                {% if ultima and not ultima.fechaTermino %}
                                    {{ ultima.farmacia.nombre }}
                                {% else %}
                                    <span class="text-muted">Sin asignación</span>
                                {% endif %}
                            {% endwith %}
                        </td>

                        <!-- ESTADO -->
                        <td>
                            {% if motorista.estado == "activo" %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                        </td>

                        <!-- ACCIONES -->
                        <td class="text-center">
                            <a href="{% url 'motorista_detalle' motorista.pk %}" class="btn btn-sm btn-info text-white me-1">
                                <i class="fas fa-eye"></i>
                            </a>

                            <a href="{% url 'motorista_editar' motorista.pk %}" class="btn btn-sm btn-warning text-white me-1">
                                <i class="fas fa-edit"></i>
                            </a>

                            <a href="{% url 'motorista_eliminar' motorista.pk %}"
                               class="btn btn-sm btn-danger"
                               onclick="return confirm('¿Eliminar motorista?');">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>

                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-3">
                            No se encontraron motoristas.
                        </td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div>

    </div>
</div>

{% include "templatesApp1Discopro/_paginator.html" %}

{% endblock %}
